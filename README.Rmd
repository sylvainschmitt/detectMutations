---
title: "detect Mutations - Fruits"
author: Sylvain Schmitt
date: September 29, 2023
output:
  github_document: 
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
opts_chunk$set(echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
               cache = F, cache.lazy = F)
```


```{r renaming, eval=FALSE}
angela_files <- data.frame(old_file = list.files("data/reads/fruits/")) %>% 
  separate(old_file, c("library", "repetition", "S", "line", 
                       "strand", "one", "file", "compression"), remove = FALSE) %>% 
  select(old_file, library, strand) %>% 
  left_join(readxl::read_xlsx("data/treemutation_fruits.xlsx", "Angela") %>% 
              mutate(library = paste0(Code_Espece, Tube))) %>% 
  mutate(new_file = paste0(gsub(".", "_", Echantillon, fixed = TRUE),
                           "_", strand, ".fq.gz"))
angela_files %>% 
  mutate(command = paste("mv", old_file, new_file)) %>% 
  select(command) %>% 
  write_tsv("data/reads/fruits/command.sh")
mutate(angela_files, library = paste0('"', gsub(".", "_", Echantillon, fixed = TRUE), '"'))$library %>% 
  unique() %>% 
  paste0(collapse = ", ") %>% 
  cat()

sixto_files <- data.frame(old_file = list.files("data/reads/sixto/")) %>% 
  separate(old_file, c("library", "repetition", "S", "line", 
                       "strand", "one", "file", "compression"), remove = FALSE) %>% 
  select(old_file, library, strand) %>% 
  left_join(readxl::read_xlsx("data/treemutation_fruits.xlsx", "Sixto") %>% 
              mutate(library = paste0(Code_Espece, Tube))) %>% 
  mutate(new_file = paste0(gsub(".", "_", Echantillon, fixed = TRUE),
                           "_", strand, ".fq.gz"))
sixto_files %>% 
  mutate(command = paste("mv", old_file, new_file)) %>% 
  select(command) %>% 
  write_tsv("data/reads/sixto/command.sh")
mutate(sixto_files, library = paste0('"', gsub(".", "_", Echantillon, fixed = TRUE), '"'))$library %>% 
  unique() %>% 
  paste0(collapse = ", ") %>% 
  cat()
```

```{r bedfiles, eval=FALSE}
read_tsv("data/angela_fruits_candidate_mutations.tsv") %>% 
  mutate(START = POS, END = POS) %>% 
  select(CHROM, START, END) %>% 
  write_tsv("data/angela.bed", col_names = FALSE)
read_tsv("data/sixto_fruits_candidate_mutations.tsv") %>% 
  mutate(START = POS-1, END = POS+1) %>% 
  select(CHROM, START, END) %>% 
  write_tsv("data/sixto.bed", col_names = FALSE)
```

[`singularity` & `snakemake`](https://github.com/sylvainschmitt/snakemake_singularity) workflow to detect mutations in fruits from Angela and Sixto.


# Installation

- [x] Python ≥3.5
- [x] Snakemake ≥5.24.1
- [x] Golang ≥1.15.2
- [x] Singularity ≥3.7.3
- [x] This workflow

```{bash, eval=F, echo=T}
# Python
sudo apt-get install python3.5
# Snakemake
sudo apt install snakemake`
# Golang
export VERSION=1.15.8 OS=linux ARCH=amd64  # change this as you need
wget -O /tmp/go${VERSION}.${OS}-${ARCH}.tar.gz https://dl.google.com/go/go${VERSION}.${OS}-${ARCH}.tar.gz && \
sudo tar -C /usr/local -xzf /tmp/go${VERSION}.${OS}-${ARCH}.tar.gz
echo 'export GOPATH=${HOME}/go' >> ~/.bashrc && \
echo 'export PATH=/usr/local/go/bin:${PATH}:${GOPATH}/bin' >> ~/.bashrc && \
source ~/.bashrc
# Singularity
mkdir -p ${GOPATH}/src/github.com/sylabs && \
  cd ${GOPATH}/src/github.com/sylabs && \
  git clone https://github.com/sylabs/singularity.git && \
  cd singularity
git checkout v3.7.3
cd ${GOPATH}/src/github.com/sylabs/singularity && \
  ./mconfig && \
  cd ./builddir && \
  make && \
  sudo make install
# detect Mutations
git clone git@github.com:sylvainschmitt/detectMutations.git
cd detectMutations
git checkout fruits
```

# Usage

## Locally

```{bash, eval=F, echo=T}
snakemake -np -j 3 --resources mem_mb=10000 # dry run
snakemake --dag | dot -Tsvg > dag/dag.svg # dag
snakemake --use-singularity -j 3 --resources mem_mb=10000 # run
```

## HPC

```{bash, eval=F, echo=T}
module load bioinfo/snakemake-5.25.0 # for test on node
snakemake -np # dry run
sbatch job.sh # run
snakemake --dag | dot -Tsvg > dag/dag.svg # dag
```

# Workflow

## Reference

*Copy and index reference.*

### [cp_reference](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/cp_reference.py)

  - Tools: `cp`

### [bwa_index](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/bwa_index.py)

  - Tools: [`BWA index`](http://bio-bwa.sourceforge.net/bwa.shtml)
  - Singularity:
    oras://registry.forgemia.inra.fr/gafl/singularity/bwa/bwa:latest
    
### [samtools_faidx](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/samtools_faidx.py)

  - Tools: [`samtools faidx`](http://www.htslib.org/doc/samtools-faidx.html)
  - Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/samtools/samtools:latest

### [gatk_dict](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/gatk_dict.py)

  - Tools: [`gatk CreateSequenceDictionary`](https://gatk.broadinstitute.org/hc/en-us/articles/360037422891-CreateSequenceDictionary-Picard-)
  - Singularity: docker://broadinstitute/gatk

## Reads

*Trim reads.*

### [trimmomatic](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/trimmomatic.py)

* Tools: [`Trimmomatic`](http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf)
* Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/trimmomatic/trimmomatic:latest

## Alignments

*Align reads against reference, mark duplicated, and report alignment quality.*

### [bwa_mem](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/bwa_mem.py)

* Tools: [`BWA mem`](http://bio-bwa.sourceforge.net/bwa.shtml)
* Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/bwa/bwa:latest

### [samtools_view](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/samtools_view.py)

* Tools: [`Samtools view`](http://www.htslib.org/doc/samtools-view.html)
* Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/samtools/samtools:latest

### [samtools_sort](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/samtools_sort.py)

* Tools: [`Samtools sort`](http://www.htslib.org/doc/samtools-sort.html)
* Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/samtools/samtools:latest

### [samtools_index](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/samtools_index.py)

* Tools: [`Samtools index`](http://www.htslib.org/doc/samtools-index.html)
* Singularity: oras://registry.forgemia.inra.fr/gafl/singularity/samtools/samtools:latest

## Variants

*Detect mutations.*

### [gatk_haplotypecaller](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/gatk_haplotypecaller.py)

* Tools: [`gatk HaplotypeCaller`](https://gatk.broadinstitute.org/hc/en-us/articles/360037052812-MarkDuplicates-Picard-)
* Singularity: docker://broadinstitute/gatk

### [gatk_genomicdbimport](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/gatk_genomicdbimport.py)

* Tools: [`gatk GenomicsDBImport`](https://gatk.broadinstitute.org/hc/en-us/articles/360037052812-MarkDuplicates-Picard-)
* Singularity: docker://broadinstitute/gatk

### [gatk_genotypegvcfs](https://github.com/sylvainschmitt/detectMutations/blob/fruits/rules/ggatk_genotypegvcfs.py)

* Tools: [`gatk GenomicsDBImport`](https://gatk.broadinstitute.org/hc/en-us/articles/360037052812-MarkDuplicates-Picard-)
* Singularity: docker://broadinstitute/gatk

# Results

```{r data, include=FALSE}
library(vcfR)
angela_vcf <- read.vcfR("results/angela.vcf")
sixto_vcf <- read.vcfR("results/sixto.vcf")
angela <- angela_vcf@fix %>% 
  as_tibble() %>% 
  separate_rows(INFO, sep = ";") %>% 
  separate(INFO, c("metric", "value"), convert = TRUE, sep = "=") %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  bind_cols(angela_vcf@gt %>% 
              as_tibble()) %>% 
  filter(paste(CHROM, POS, REF, ALT) %in% 
           with(read_tsv("data/angela_fruits_candidate_mutations.tsv"),
                paste(CHROM, POS, REF, ALT))) %>% 
  select(-ID, -FILTER, -AN, -ExcessHet, -FS, -InbreedingCoeff, -MLEAC, -MLEAF,
         -MQ, -QD, -SOR, -BaseQRankSum, -MQRankSum, -ReadPosRankSum, -AC) %>% 
  gather(library, values, -CHROM, -POS, -REF, -ALT, -QUAL, -AF, -DP, -FORMAT) %>% 
  mutate(POS = as.numeric(POS)) %>% 
  left_join(read_tsv("data/angela_fruits_candidate_mutations.tsv")) %>% 
  separate(values, c("GT", "AD", "DP_lib"),":", convert = TRUE) %>% 
  select(-FORMAT) %>% 
  separate(AD, c("AC_REF", "AC_ALT"), convert = TRUE) %>% 
  mutate(AF_lib = AC_ALT / DP_lib)
sixto <- sixto_vcf@fix %>% 
  as_tibble() %>% 
  separate_rows(INFO, sep = ";") %>% 
  separate(INFO, c("metric", "value"), convert = TRUE, sep = "=") %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  bind_cols(sixto_vcf@gt %>% 
              as_tibble()) %>% 
  filter(paste(CHROM, POS, REF, ALT) %in% 
           with(read_tsv("data/sixto_fruits_candidate_mutations.tsv"),
                paste(CHROM, POS, REF, ALT))) %>% 
  select(-ID, -FILTER, -AN, -ExcessHet, -FS, -InbreedingCoeff, -MLEAC, -MLEAF,
         -MQ, -QD, -SOR, -BaseQRankSum, -MQRankSum, -ReadPosRankSum, -AC) %>% 
  gather(library, values, -CHROM, -POS, -REF, -ALT, -QUAL, -AF, -DP, -FORMAT) %>% 
  mutate(POS = as.numeric(POS)) %>% 
  left_join(read_tsv("data/sixto_fruits_candidate_mutations.tsv")) %>% 
  separate(values, c("GT", "AD", "DP_lib"),":", convert = TRUE) %>% 
  select(-FORMAT) %>% 
  separate(AD, c("AC_REF", "AC_ALT"), convert = TRUE) %>% 
  mutate(AF_lib = AC_ALT / DP_lib)
all <- bind_rows(
  angela %>% 
    separate(library, c("species", "branch_mutation", "fruit", "tissue"), 
             remove = FALSE) %>% 
    separate_rows(branch) %>% 
    mutate(tree = "angela"),
  sixto %>% 
    separate(library, c("species", "branch_mutation", "fruit", "tissue"), 
             remove = FALSE) %>% 
    separate_rows(branch) %>% 
    mutate(tree = "sixto")
) %>% 
  mutate(fruit = sprintf("%02d", as.numeric(fruit))) %>% 
  mutate(CHROM = gsub("Super-Scaffold_", "", CHROM)) %>% 
  mutate(CHROM = sprintf("%02d", as.numeric(CHROM))) %>% 
  mutate(POS = sprintf("%09d", as.numeric(POS))) %>% 
  mutate(SNV = paste0(CHROM, "#", POS)) 
rm(angela_vcf, sixto_vcf, angela, sixto)
```

```{r data2, include=FALSE}
library(vcfR)
angela_vcf <- read.vcfR("results/angela_filtered.vcf")
sixto_vcf <- read.vcfR("results/sixto_filtered.vcf")
angela <- angela_vcf@fix %>% 
  as_tibble() %>% 
  separate_rows(INFO, sep = ";") %>% 
  separate(INFO, c("metric", "value"), convert = TRUE, sep = "=") %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  bind_cols(angela_vcf@gt %>% 
              as_tibble()) %>% 
  filter(paste(CHROM, POS, REF, ALT) %in% 
           with(read_tsv("data/angela_fruits_candidate_mutations.tsv"),
                paste(CHROM, POS, REF, ALT))) %>% 
  select(-ID, -FILTER, -AN, -ExcessHet, -FS, -InbreedingCoeff, -MLEAC, -MLEAF,
         -MQ, -QD, -SOR, -BaseQRankSum, -MQRankSum, -ReadPosRankSum, -AC) %>% 
  gather(library, values, -CHROM, -POS, -REF, -ALT, -QUAL, -AF, -DP, -FORMAT) %>% 
  mutate(POS = as.numeric(POS)) %>% 
  left_join(read_tsv("data/angela_fruits_candidate_mutations.tsv")) %>% 
  separate(values, c("GT", "AD", "DP_lib"),":", convert = TRUE) %>% 
  select(-FORMAT) %>% 
  separate(AD, c("AC_REF", "AC_ALT"), convert = TRUE) %>% 
  mutate(AF_lib = AC_ALT / DP_lib)
sixto <- sixto_vcf@fix %>% 
  as_tibble() %>% 
  separate_rows(INFO, sep = ";") %>% 
  separate(INFO, c("metric", "value"), convert = TRUE, sep = "=") %>% 
  pivot_wider(names_from = metric, values_from = value) %>% 
  bind_cols(sixto_vcf@gt %>% 
              as_tibble()) %>% 
  filter(paste(CHROM, POS, REF, ALT) %in% 
           with(read_tsv("data/sixto_fruits_candidate_mutations.tsv"),
                paste(CHROM, POS, REF, ALT))) %>% 
  select(-ID, -FILTER, -AN, -ExcessHet, -FS, -InbreedingCoeff, -MLEAC, -MLEAF,
         -MQ, -QD, -SOR, -BaseQRankSum, -MQRankSum, -ReadPosRankSum, -AC) %>% 
  gather(library, values, -CHROM, -POS, -REF, -ALT, -QUAL, -AF, -DP, -FORMAT) %>% 
  mutate(POS = as.numeric(POS)) %>% 
  left_join(read_tsv("data/sixto_fruits_candidate_mutations.tsv")) %>% 
  separate(values, c("GT", "AD", "DP_lib"),":", convert = TRUE) %>% 
  select(-FORMAT) %>% 
  separate(AD, c("AC_REF", "AC_ALT"), convert = TRUE) %>% 
  mutate(AF_lib = AC_ALT / DP_lib)
filtered <- bind_rows(
  angela %>% 
    separate(library, c("species", "branch_mutation", "fruit", "tissue"), 
             remove = FALSE) %>% 
    separate_rows(branch) %>% 
    mutate(tree = "angela"),
  sixto %>% 
    separate(library, c("species", "branch_mutation", "fruit", "tissue"), 
             remove = FALSE) %>% 
    separate_rows(branch) %>% 
    mutate(tree = "sixto")
) %>% 
  mutate(fruit = sprintf("%02d", as.numeric(fruit))) %>% 
  mutate(CHROM = gsub("Super-Scaffold_", "", CHROM)) %>% 
  mutate(CHROM = sprintf("%02d", as.numeric(CHROM))) %>% 
  mutate(POS = sprintf("%09d", as.numeric(POS))) %>% 
  mutate(SNV = paste0(CHROM, "#", POS)) %>% 
  filter(AF_lib >= 0.1) %>% 
  select(SNV, library) %>% 
  mutate(gatk = 1)
all <- all %>% 
  left_join(filtered) %>% 
  mutate(gatk = ifelse(is.na(gatk), 0, 1)) 
rm(angela_vcf, sixto_vcf, angela, sixto, filtered)
```


```{r, fig.height=7, fig.width=14}
gs <- all %>% 
  filter(tree == "sixto") %>%
  filter(branch_mutation != "A") %>% 
  mutate(branch_mutation = recode(branch_mutation, "B" = "B1")) %>% 
  bind_rows(all %>% 
              filter(tree == "sixto") %>%
              select(SNV, af, branch) %>% 
              mutate(fruit = "tree") %>% 
              rename(tissue = branch, AF_lib = af) %>% 
              mutate(branch_mutation = "") %>% 
              mutate(gatk = 0)) %>%
  mutate(tissue_col = ifelse(!is.na(AF_lib), branch_mutation, "No data")) %>% 
  mutate(tissue_col = ifelse(branch_mutation  == "", tissue, tissue_col)) %>% 
  filter(!(!is.nan(AF_lib) & AF_lib == 0)) %>% 
  mutate(AF_lib = ifelse(is.na(AF_lib), 0.5, AF_lib)) %>% 
  mutate(AF_lib = ifelse(AF_lib == 0, 1, AF_lib)) %>% 
  mutate(AF_lib = ifelse(AF_lib > 0.5, 0.5, AF_lib)) %>% 
  select(branch_mutation, fruit, tissue, tissue_col, SNV, AF_lib, gatk) %>% 
  unique() %>% 
  ggplot(aes(tissue, SNV)) +
  geom_tile(aes(fill = tissue_col, alpha = AF_lib, col = as.factor(gatk)), linewidth = 1.5) +
  facet_grid(~ paste0(branch_mutation, "\n", fruit), scales = "free_x", space = "free_x") +
  theme_bw() +
  scale_alpha_continuous(guide = "none", range = c(0.1, 1)) +
  ylab("") + xlab("") +
  theme(legend.position = "bottom", panel.spacing = unit(0,'lines'),
        axis.text.x = element_text(angle = 90),
        panel.grid.major = element_blank()) +
  geom_vline(xintercept = seq(0.5, 3.5, by = 1), color="gray", size=.5, alpha=.5) +
  geom_hline(yintercept = seq(0.5, 30.5, by = 1), color="gray", size=.5, alpha=.5) +
  geom_point(aes(fill = "No mutation"), alpha = 0) +
  scale_fill_manual("",
                    values = c("#E69F00", "#56B4E9", "#009E73",
                               "#F0E442", "#0072B2", "#D55E00",
                               "#000000", "white")) +
  scale_color_manual("GATK", values = c(NA, "red"), labels = c("no", "yes"),
                     na.value = NA) +
  ggnewscale::new_scale_color() +
  geom_point(aes(col = AF_lib), alpha = 0) +
  scale_colour_gradient("Allele\nfraction", high = "#333333", low = "#c9c9c9") +
  ggtitle("Sextonia rubra")
gs
```

```{r, fig.height=7, fig.width=14}
ga <- all %>% 
filter(tree == "angela") %>%
  bind_rows(all %>% 
              filter(tree == "angela") %>%
              select(SNV, af, branch) %>% 
              mutate(fruit = "tree") %>% 
              rename(tissue = branch, AF_lib = af) %>% 
              mutate(branch_mutation = "") %>% 
              mutate(gatk = 0)) %>%
  mutate(tissue_col = ifelse(!is.na(AF_lib), branch_mutation, "No data")) %>% 
  mutate(tissue_col = ifelse(branch_mutation  == "", tissue, tissue_col)) %>% 
  filter(!(!is.nan(AF_lib) & AF_lib == 0)) %>% 
  mutate(AF_lib = ifelse(is.na(AF_lib), 0.5, AF_lib)) %>% 
  mutate(AF_lib = ifelse(AF_lib == 0, 1, AF_lib)) %>% 
  mutate(AF_lib = ifelse(AF_lib > 0.5, 0.5, AF_lib)) %>% 
  select(branch_mutation, fruit, tissue, tissue_col, SNV, AF_lib, gatk) %>% 
  unique() %>% 
  ggplot(aes(tissue, SNV)) +
  geom_tile(aes(fill = tissue_col, alpha = AF_lib, col = as.factor(gatk)), linewidth = 1.5) +
  facet_grid(~ paste0(branch_mutation, "\n", fruit), scales = "free_x", space = "free_x") +
  theme_bw() +
  scale_alpha_continuous(guide = "none", range = c(0.1, 1)) +
  ylab("") + xlab("") +
  theme(legend.position = "bottom", panel.spacing = unit(0,'lines'),
        axis.text.x = element_text(angle = 90),
        panel.grid.major = element_blank()) +
  geom_vline(xintercept = seq(0.5, 3.5, by = 1), color="gray", size=.5, alpha=.5) +
  geom_hline(yintercept = seq(0.5, 30.5, by = 1), color="gray", size=.5, alpha=.5) +
  geom_point(aes(fill = "No mutation"), alpha = 0) +
  scale_fill_manual("",
                    values = c("#E69F00", "#56B4E9", "#009E73", 
                               "#F0E442", "#000000", "white")) +
  scale_color_manual("GATK", values = c(NA, "red"), labels = c("no", "yes"),
                     na.value = NA) +
  ggnewscale::new_scale_color() +
  geom_point(aes(col = AF_lib), alpha = 0) +
  scale_colour_gradient("Allele\nfraction", high = "#333333", low = "#c9c9c9") +
  ggtitle("Dicorynia guianensis")
ga
```

```{r, fig.height=10, fig.width=16}
gt <- cowplot::plot_grid(ga, gs, nrow = 2, rel_heights = c(4,2))
ggsave(plot = gt, filename = "matrice_all.png", height = 10, width = 16)
```

```{r, eval=FALSE}
pdf("all_count.pdf")
for(snv in unique(all$SNV))
  print(all %>% 
  filter(SNV == snv) %>% 
  select(SNV, AC_REF, AC_ALT, branch_mutation, fruit, tissue) %>% 
  gather(type, ac, -SNV, -branch_mutation, -fruit, -tissue) %>% 
  mutate(type = gsub("AC_", "", type)) %>% 
  mutate(tissue = factor(tissue, levels = c("ba", "pe", "ec", "co", "nu", "es"))) %>% 
  ggplot(aes(tissue, ac, fill = type)) +
  geom_col() +
  theme_bw() +
  facet_wrap(~ paste0(branch_mutation, "-", fruit)) +
  scale_fill_manual(guide = "none", values = c("firebrick", "lightgrey")) +
  xlab("") + ylab("Number of reads") +
  ggtitle(snv))
dev.off()
```

```{r}
all %>% 
  select(species, branch_mutation, fruit, tissue, 
         CHROM, POS, REF, ALT, AC_REF, AC_ALT, DP_lib, AF_lib, gatk) %>% 
  mutate(species = ifelse(species == "DG", "Dicorynia guianensis",
                          "Sextonia rubra")) %>% 
  mutate(tissue = recode(tissue)) %>% 
  # rename tissue
  rename(branch = branch_mutation, scaffold = CHROM, position = POS,
         normal = REF, mutation = ALT, normal_read_count = AC_REF,
         mutation_read_count = AC_ALT, sequencing_depth = DP_lib,
         allelic_fraction = AF_lib, gatk_filtering = gatk)
# save as table
```





